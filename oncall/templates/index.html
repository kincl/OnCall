<!DOCTYPE html>
<html>
<head>
<link href='{{ url_for('static', filename='fullcalendar/fullcalendar/fullcalendar.css') }}' rel='stylesheet' />
<!--<link href='{{ url_for('static', filename='fullcalendar/fullcalendar/fullcalendar.print.css') }}' rel='stylesheet' media='print' />-->
<script src='{{ url_for('static', filename='fullcalendar/lib/jquery.min.js') }}'></script>
<script src='{{ url_for('static', filename='fullcalendar/lib/jquery-ui.custom.min.js') }}'></script>
<script src='{{ url_for('static', filename='fullcalendar/fullcalendar/fullcalendar.min.js') }}'></script>
<script>
function pad(n, width, z) {
  z = z || '0';
  n = n + '';
  return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

function formatDate(d) {
    //getMonth starts at 0 for some reason..
    return d.getFullYear()+'-'+pad(d.getMonth()+1,2)+'-'+pad(d.getDate(),2)
}

function showMenu(event_id, event_target) {
    $('#menu').remove();
    //console.log($(event_target).height());
    var os = $(event_target).offset()
    os['top'] = os['top'] + $(event_target).height() + 5;
    var menu = $("<div id='menu'/>");
    menu.css(os);
    menu.html("Hello");
    menu.appendTo('body');
    menu.click(function () { $(this).remove() })
}

$(document).ready(function() {
    // Set up calendar
    $('#calendar').fullCalendar({
        editable: true,
        droppable: true,
        events: "/get_events",
        
        eventDrop: function(event, delta) {
            //console.log(event);
        },

        eventResize: function(event, delta) {
            $.post('{{ url_for('update_event') }}',
                   {'start': formatDate(event.start),
                    'end': formatDate(event.end),
                    'username': $(this).attr('id')});

            $('#calendar').fullCalendar('refetchEvents');
        },

        drop: function(date, allDay) { // this function is called when something is dropped

            $.post('{{ url_for('update_event') }}',
                   {'start': formatDate(date),
                    'username': $(this).attr('id')});

            $('#calendar').fullCalendar('refetchEvents');
        },
        
        loading: function(bool) {
            if (bool) $('#loading').show();
            else $('#loading').hide();
        },

        eventDragStart: function(calEvent, jsEvent, ui, view) {
            $('#menu').remove()
        },

        eventResizeStart: function(calEvent, jsEvent, ui, view) {
            $('#menu').remove()
        },

        eventClick: function(calEvent, jsEvent, view) {
            // alert('Event: ' + calEvent.title);
            // alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
            // alert('View: ' + view.name);

            // change the border color just for fun
            //$(this).css('border-color', 'red');

            showMenu(calEvent.id, jsEvent.currentTarget);
        }
    });

    // Set up team
    $.getJSON( "/get_team_members/team1", function( data ) {
        var items = [];
        $.each( data, function( key, val ) {
            var member = $("<div/>", {
                           "class": "team_member",
                           "id": val['id'],
                           text: val['name']
                          })

            $(member).draggable({
                zIndex: 999,
                revert: true,      // will cause the event to go back to its
                revertDuration: 0  //  original position after the drag
            });

            items.push(member);
        });
        $("#team_members").append(items);
    });
});
</script>
<style>

    body {
        margin-top: 40px;
        text-align: center;
        font-size: 14px;
        font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
        }
        
    #wrap {
        width: 1100px;
        margin: 0 auto;
        }

    #team_members {
        float: left;
        width: 150px;
        padding: 0 10px;
        border: 1px solid #ccc;
        background: #eee;
        text-align: left;
        }

    .team_member { /* try to mimick the look of a real event */
        margin: 10px 0;
        padding: 2px 4px;
        background: #3366CC;
        color: #fff;
        font-size: .85em;
        cursor: pointer;
        }

    #loading {
        position: absolute;
        top: 5px;
        right: 5px;
        }

    #calendar {
        float: right;
        width: 900px;
        margin: 0 auto;
        }

    #menu {
        z-index: 100;
        position: absolute;
        width: 100px;
        height: 50px;
        padding: 10px;
        overflow: hidden;
        background-color: #ddd;
        border: solid 2px #000;
    }

</style>
</head>
<body>
<div id='wrap'>
<div id='team_members'></div>
<div id='loading' style='display:none'>loading...</div>
<div id='calendar'></div>
</div>
</body>
</html>