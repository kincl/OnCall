<!DOCTYPE html>
<html>
<head>
<link href='{{ url_for('static', filename='fullcalendar/fullcalendar/fullcalendar.css') }}' rel='stylesheet' />
<link href='{{ url_for('static', filename='qtip2/jquery.qtip.min.css') }}' rel='stylesheet' />
<!--<link href='{{ url_for('static', filename='fullcalendar/fullcalendar/fullcalendar.print.css') }}' rel='stylesheet' media='print' />-->
<script src='{{ url_for('static', filename='fullcalendar/lib/jquery.min.js') }}'></script>
<script src='{{ url_for('static', filename='fullcalendar/lib/jquery-ui.custom.min.js') }}'></script>
<script src='{{ url_for('static', filename='fullcalendar/fullcalendar/fullcalendar.min.js') }}'></script>
<script src='{{ url_for('static', filename='qtip2/jquery.qtip.min.js') }}'></script>
<script>
var global = {};

function pad(n, width, z) {
  z = z || '0';
  n = n + '';
  return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

function formatDate(d) {
    //getMonth starts at 0 for some reason..
    if (d == null) { 
        return null 
    } 
    else {
        return d.getFullYear()+'-'+pad(d.getMonth()+1,2)+'-'+pad(d.getDate(),2);
    }
}

function delete_event(event_id) {
    $.post('{{ url_for("delete_event", eventid="") }}' + event_id);
    $('#calendar').fullCalendar('refetchEvents');
    global.menu.hide()
}

function updateAndRefetch(event, delta) {
    $.post('{{ url_for("update_event", eventid="") }}' + event.id,
           {'start': formatDate(event.start),
            'end': formatDate(event.end),
            'username': $(this).attr('id')});

    $('#calendar').fullCalendar('refetchEvents');
}

function get_color(offset) {
    if (!offset) { offset = 0; }
    var num=offset*102;
    num = num + parseInt(num/360)*79
    return 'hsl('+num+', 60%, 50%)';
}

$(document).ready(function() {
    var menu = $('<div/>').qtip({
        //id: 'calendar',
        prerender: true,
        content: {
            text: ' ',
            title: {
                button: true
            }
        },
        position: {
            my: 'bottom center',
            at: 'top center',
            target: 'mouse',
            viewport: $('#calendar'),
            adjust: {
                mouse: false,
                scroll: false
            }
        },
        show: false,
        hide: false,
        style: 'qtip-light qtip-rounded'
    }).qtip('api');
    global.menu = menu;

    // Set up team
    $.getJSON( "/get_team_members/team1", function( data ) {
        var items = [];
        var team_colors = {};
        $.each( data, function( key, val ) {
            var background = get_color(Object.keys(team_colors).length);
            var member = $("<div/>", {
                           "class": "team_member",
                           "id": val['id'],
                           text: val['name']
                          })
            $(member).draggable({
                zIndex: 999,
                revert: true,      // will cause the event to go back to its
                revertDuration: 0  //  original position after the drag
            });
            items.push(member);

            $(member).css('background-color', background);
            team_colors[val['id']] = background;
        });
        global.team_colors = team_colors;
        $("#team_members").append(items);
    });

    // Set up calendar
    $('#calendar').fullCalendar({
        firstDay: 1,
        editable: true,
        droppable: true,
        events: "/get_events",
        
        eventDrop: updateAndRefetch,

        eventResize: updateAndRefetch,

        drop: function(date, allDay) { // this function is called when something is dropped
            $.post('{{ url_for('create_event') }}',
                   {'start': formatDate(date),
                    'username': $(this).attr('id')});

            $('#calendar').fullCalendar('refetchEvents');
        },
        
        loading: function(bool) {
            if (bool) $('#loading').show();
            else $('#loading').hide();
        },

        eventDragStart: function() { global.menu.hide() },
        eventResizeStart: function() { global.menu.hide() },
        dayClick: function() { global.menu.hide() },
        viewDisplay: function() { global.menu.hide() },

        eventClick: function(data, event, view) {
            var content = '<button onclick="delete_event('+data.id+')" >Delete me</button>'
            menu.set({
                'content.text': content
            })
            .reposition(event).show(event);
        },

        dayRender: function (date, cell) {
            if (date.getDay() == 6 || date.getDay() == 0) {
                $(cell).css('background-color', '#f8f8f8')
            }
        },

        eventRender: function (event, element, view) {
            $(element).css('background-color', global.team_colors[event.user_username]);
            $(element).css('border', '1px solid '+global.team_colors[event.user_username]);
        }
    });
});
</script>
<style>

    body {
        margin-top: 40px;
        text-align: center;
        font-size: 14px;
        font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
        }
        
    #wrap {
        width: 1100px;
        margin: 0 auto;
        }

    #team_members {
        float: left;
        width: 150px;
        padding: 0 10px;
        border: 1px solid #ccc;
        background: #eee;
        text-align: left;
        }

    .team_member { /* try to mimick the look of a real event */
        margin: 10px 0;
        padding: 2px 4px;
        background: #3366CC;
        color: #fff;
        font-size: .85em;
        cursor: pointer;
        }

    #loading {
        position: absolute;
        top: 5px;
        right: 5px;
        }

    #calendar {
        float: right;
        width: 900px;
        margin: 0 auto;
        }

    #menu {
        z-index: 100;
        position: absolute;
        width: 100px;
        height: 50px;
        padding: 10px;
        overflow: hidden;
        background-color: #ddd;
        border: solid 2px #000;
    }

</style>
</head>
<body>
<div id='wrap'>
<div id='team_members'></div>
<div id='loading' style='display:none'>loading...</div>
<div id='calendar'></div>
</div>
</body>
</html>
